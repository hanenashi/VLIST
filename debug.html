<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Visnový list – Debug tabulky</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .page {
      max-width: 1100px;
      margin: 1.5rem auto;
      padding: 0 1rem 2rem;
    }

    h1 {
      margin: 0 0 0.3rem;
      font-size: 1.6rem;
    }

    .subtitle {
      margin: 0 0 1rem;
      font-size: 0.9rem;
      color: #555;
    }

    .info {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 1rem;
    }

    .tables {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .card {
      background: #fff;
      border-radius: 8px;
      padding: 0.8rem 0.9rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      border: 1px solid #ddd;
      overflow-x: auto;
    }

    .card h2 {
      margin: 0 0 0.4rem;
      font-size: 1.1rem;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 600px;
      font-size: 0.8rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      text-align: left;
      vertical-align: top;
      max-width: 240px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    th {
      background: #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tr:nth-child(even) td {
      background: #fafafa;
    }

    tr:hover td {
      background: #fff7d6;
    }

    code {
      background: #eee;
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 0.75rem;
    }

    .status-chip {
      display: inline-block;
      padding: 0 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      line-height: 1.5;
      border: 1px solid transparent;
    }
    .status-default {
      background: #fff;
      border-color: #ccc;
    }
    .status-reserved {
      background: #dfe7ff;
      border-color: #9bb4ff;
    }
    .status-bought {
      background: #d8ffd8;
      border-color: #90d790;
    }

    .raw-json {
      margin-top: 1.5rem;
      font-size: 0.75rem;
    }

    textarea {
      width: 100%;
      min-height: 200px;
      font-family: "Consolas", "SF Mono", ui-monospace, monospace;
      font-size: 0.75rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 6px;
      box-sizing: border-box;
      background: #111;
      color: #e0e0e0;
      resize: vertical;
    }
  </style>
</head>
<body>
  <main class="page">
    <h1>Visnový list – Debug tabulky</h1>
    <p class="subtitle">
      Rychlý náhled do tabulek <code>wishlist</code> a <code>wishlist_items</code> přes API.
    </p>
    <p class="info">
      Tahle stránka používá <code>/api/wishlist</code>. Vhodné na rychlou kontrolu dat bez
      přepínání do Beekeeperu / Neon UI. Kliknutím a tažením můžeš kopírovat celé řádky
      jako z Excelu.
    </p>

    <div id="status" class="info">Načítám data…</div>

    <div class="tables">
      <section class="card">
        <h2>Tabulka: wishlist</h2>
        <div id="wishlist-table">Načítám…</div>
      </section>

      <section class="card">
        <h2>Tabulka: wishlist_items</h2>
        <div id="items-table">Načítám…</div>
      </section>
    </div>

    <section class="raw-json">
      <h2>Raw JSON z /api/wishlist</h2>
      <textarea id="raw-json" readonly>Načítám…</textarea>
    </section>
  </main>

  <script>
    // Same logic as main.js
    const VERCEL_BASE = 'https://vlist-kappa.vercel.app';

    function getApiBase() {
      const host = window.location.hostname;
      if (host.endsWith('vercel.app')) {
        return '';
      }
      return VERCEL_BASE;
    }

    function escapeHtml(str) {
      if (str == null) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function buildTable(container, rows, explicitColumns) {
      if (!rows || rows.length === 0) {
        container.innerHTML = '<em>Žádné záznamy.</em>';
        return;
      }

      const columns = explicitColumns && explicitColumns.length
        ? explicitColumns
        : Object.keys(rows[0]);

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const trHead = document.createElement('tr');
      columns.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      rows.forEach(row => {
        const tr = document.createElement('tr');
        columns.forEach(col => {
          const td = document.createElement('td');
          let val = row[col];

          if (val === null || val === undefined) {
            td.innerHTML = '<span style="color:#aaa">NULL</span>';
          } else if (col === 'status') {
            const s = String(val).toLowerCase();
            let cls = 'status-default';
            if (s === 'reserved') cls = 'status-reserved';
            else if (s === 'bought') cls = 'status-bought';
            td.innerHTML = '<span class="status-chip ' + cls + '">' + escapeHtml(val) + '</span>';
          } else if (val instanceof Date) {
            td.textContent = val.toISOString();
          } else {
            td.textContent = String(val);
          }

          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      container.innerHTML = '';
      container.appendChild(table);
    }

    async function loadDebug() {
      const statusEl = document.getElementById('status');
      const wishlistBox = document.getElementById('wishlist-table');
      const itemsBox = document.getElementById('items-table');
      const rawBox = document.getElementById('raw-json');

      const apiBase = getApiBase();
      statusEl.textContent = 'Načítám z ' + (apiBase || '(stejného původu)') + '/api/wishlist';

      try {
        const resp = await fetch(apiBase + '/api/wishlist');
        if (!resp.ok) {
          const txt = await resp.text();
          throw new Error('HTTP ' + resp.status + ': ' + txt);
        }

        const data = await resp.json();
        rawBox.value = JSON.stringify(data, null, 2);

        if (!data || data.length === 0) {
          wishlistBox.innerHTML = '<em>Žádné wishlisty.</em>';
          itemsBox.innerHTML = '<em>Žádné položky.</em>';
          statusEl.textContent = 'Načteno: 0 wishlistů.';
          return;
        }

        // Build wishlist rows
        const wishlistRows = data.map(row => ({
          id: row.id,
          title: row.title,
          slug: row.slug,
          is_public: row.is_public,
          created_at: row.created_at,
          description: row.description
        }));

        // Flatten items from all lists
        const itemRows = [];
        data.forEach(list => {
          if (Array.isArray(list.items)) {
            list.items.forEach(it => {
              itemRows.push({
                id: it.id,
                wishlist_id: it.wishlist_id,
                name: it.name,
                price: it.price,
                status: it.status,
                is_public: it.is_public,
                link: it.link,
                note: it.note,
                created_at: it.created_at
              });
            });
          }
        });

        buildTable(
          wishlistBox,
          wishlistRows,
          ['id', 'title', 'slug', 'is_public', 'created_at', 'description']
        );

        buildTable(
          itemsBox,
          itemRows,
          ['id', 'wishlist_id', 'name', 'price', 'status', 'is_public', 'link', 'note', 'created_at']
        );

        statusEl.textContent =
          'Načteno: ' +
          wishlistRows.length + ' wishlistů, ' +
          itemRows.length + ' položek.';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Chyba načítání: ' + err.message;
        wishlistBox.textContent = 'Chyba.';
        itemsBox.textContent = 'Chyba.';
        rawBox.value = 'Chyba: ' + err.message;
      }
    }

    document.addEventListener('DOMContentLoaded', loadDebug);
  </script>
</body>
</html>
